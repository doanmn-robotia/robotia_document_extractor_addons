<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">
    <t t-name="robotia_document_extractor.HfcDashboard">
        <div class="hfc-dashboard-container">

            <!-- SIDEBAR FILTER -->
            <aside class="hfc-sidebar" t-if="state.sidebarVisible">
                <div class="sidebar-header">
                    <h2>Search Panel</h2>
                </div>

                <!-- Scrollable content area -->
                <div class="hfc-sidebar-content">
                    <!-- Filter Group: Doanh nghiệp -->
                <div class="filter-group">
                    <div class="filter-group-title">Doanh nghiệp</div>

                    <div class="filter-row">
                        <label>Tên doanh nghiệp</label>
                        <input type="text"
                               class="form-control form-control-sm"
                               t-model="state.filters.organization_search"
                               placeholder="Nhập tên doanh nghiệp..."/>
                    </div>

                    <div class="filter-row">
                        <label>Mã doanh nghiệp</label>
                        <input type="text"
                               class="form-control form-control-sm"
                               t-model="state.filters.organization_code"
                               placeholder="Ví dụ: 0101234567"/>
                    </div>

                    <div class="filter-row">
                        <label>Tỉnh/Thành phố</label>
                        <select class="form-select form-select-sm" t-model="state.filters.province">
                            <option value="">-- Tất cả --</option>
                            <t t-foreach="state.filterMetadata.provinces" t-as="province" t-key="province_index">
                                <option t-att-value="province" t-esc="province"/>
                            </t>
                        </select>
                    </div>
                </div>

                <!-- Filter Group: Lĩnh vực hoạt động -->
                <!-- Filter Group: Lĩnh vực hoạt động (Dynamic from DB) -->
                <div class="filter-group">
                    <div class="filter-group-title">Lĩnh vực hoạt động</div>
                    <div class="filter-checkbox-list">
                        <t t-foreach="state.filterMetadata.activityFields" t-as="field" t-key="field.id">
                            <label class="filter-checkbox-item">
                                <input type="checkbox"
                                       t-att-checked="state.filters.activity_field_ids.includes(field.id)"
                                       t-on-change="() => this.toggleActivityField(field.id)"/>
                                <span t-esc="field.name"/>
                            </label>
                        </t>
                    </div>
                </div>

                <!-- Filter Group: Chất được kiểm soát -->
                <div class="filter-group">
                    <div class="filter-group-title">Chất được kiểm soát</div>

                    <div class="filter-row">
                        <label>Tên chất</label>
                        <input type="text"
                               class="form-control form-control-sm"
                               t-model="state.filters.substance_name"
                               placeholder="Ví dụ: R32"/>
                    </div>

                    <div class="filter-row">
                        <label>Mã HS</label>
                        <input type="text"
                               class="form-control form-control-sm"
                               t-model="state.filters.hs_code"
                               placeholder="Ví dụ: 2903.39.90"/>
                    </div>

                    <div class="filter-row">
                        <label>Nhóm chất</label>
                        <select class="form-select form-select-sm" t-model.number="state.filters.substance_group_id">
                            <option value="">-- Tất cả --</option>
                            <t t-foreach="state.filterMetadata.substanceGroups" t-as="group" t-key="group.id">
                                <option t-att-value="group.id" t-esc="group.name"/>
                            </t>
                        </select>
                    </div>
                </div>

                <!-- Filter Group: Chỉ tiêu báo cáo -->
                <div class="filter-group">
                    <div class="filter-group-title">Chỉ tiêu báo cáo</div>

                    <div class="filter-row">
                        <label>Năm từ</label>
                        <select class="form-select form-select-sm" t-model.number="state.filters.year_from">
                            <option value="">-- Từ năm --</option>
                            <t t-foreach="state.filterMetadata.years" t-as="year" t-key="year">
                                <option t-att-value="year" t-esc="year"/>
                            </t>
                        </select>
                    </div>

                    <div class="filter-row">
                        <label>Năm đến</label>
                        <select class="form-select form-select-sm" t-model.number="state.filters.year_to">
                            <option value="">-- Đến năm --</option>
                            <t t-foreach="state.filterMetadata.years" t-as="year" t-key="year">
                                <option t-att-value="year" t-esc="year"/>
                            </t>
                        </select>
                    </div>
                </div>

                <!-- Filter Group: Trạng thái hồ sơ (Dynamic from DB) -->
                <div class="filter-group">
                    <div class="filter-group-title">Trạng thái hồ sơ</div>
                    <div class="filter-checkbox-list">
                        <t t-foreach="state.filterMetadata.statusOptions" t-as="status" t-key="status.value">
                            <label class="filter-checkbox-item">
                                <input type="checkbox"
                                       t-att-checked="state.filters.status.includes(status.value)"
                                       t-on-change="() => this.toggleStatus(status.value)"/>
                                <span t-esc="status.label"/>
                            </label>
                        </t>
                    </div>
                </div>

                </div><!-- End .hfc-sidebar-content -->

                <!-- Filter Actions (Always visible at bottom) -->
                <div class="btn-filter-actions">
                    <button class="btn btn-primary btn-sm" t-on-click="() => this.applyFilters()">
                        <i class="fa fa-filter"/> Áp dụng
                    </button>
                    <button class="btn btn-secondary btn-sm" t-on-click="() => this.clearFilters()">
                        <i class="fa fa-times"/> Xóa lọc
                    </button>
                </div>
            </aside>

            <!-- MAIN DASHBOARD -->
            <main class="hfc-main">

                <!-- Loading State -->
                <div t-if="state.loading" class="dashboard-loading">
                    <i class="fa fa-spinner fa-spin fa-3x text-primary"/>
                    <p class="mt-3">Đang tải dữ liệu dashboard...</p>
                </div>

                <!-- Error State -->
                <div t-elif="state.error" class="dashboard-error">
                    <div class="alert alert-danger">
                        <i class="fa fa-exclamation-triangle"/>
                        <span t-esc="state.error"/>
                    </div>
                </div>

                <!-- Main Content -->
                <div t-else="" class="hfc-content">

                    <!-- Header -->
                    <div class="main-header">
                        <div>
                            <div class="main-header-title">
                                <i class="fa fa-dashboard"/> Dashboard HFC – Tra cứu &amp; Tổng hợp
                            </div>
                            <div class="main-header-sub">
                                Tổng quan dữ liệu đã OCR từ Mẫu 01/02, hỗ trợ tra cứu &amp; phân tích đa chiều.
                            </div>
                        </div>
                        <div class="main-header-actions">
                            <button class="btn btn-sm btn-secondary" t-on-click="() => this.exportReport()">
                                <i class="fa fa-download"/> Xuất báo cáo
                            </button>
                        </div>
                    </div>

                    <!-- KPI Row -->
                    <section class="kpi-row">
                        <div class="kpi-card">
                            <div class="kpi-label">
                                <span>Tổng số doanh nghiệp</span>
                                <span class="kpi-pill">Từ dữ liệu OCR</span>
                            </div>
                            <div class="kpi-value" t-esc="formatNumber(state.kpiData.total_organizations, 0)"/>
                            <div class="kpi-sub">Đã nộp Mẫu 01/02</div>
                        </div>

                        <div class="kpi-card">
                            <div class="kpi-label">
                                <span>Tổng khối lượng (kg)</span>
                                <span class="kpi-pill">Tất cả chất</span>
                            </div>
                            <div class="kpi-value" t-esc="formatNumber(state.kpiData.total_kg, 0)"/>
                            <div class="kpi-sub">Tổng hợp từ bảng 1.1 + 1.3</div>
                        </div>

                        <div class="kpi-card">
                            <div class="kpi-label">
                                <span>Tổng CO₂ tương đương</span>
                                <span class="kpi-pill">CO₂e</span>
                            </div>
                            <div class="kpi-value" t-esc="formatCO2e(state.kpiData.total_co2e)"/>
                            <div class="kpi-sub">Dựa trên hệ số GWP</div>
                        </div>

                        <div class="kpi-card">
                            <div class="kpi-label">
                                <span>% hồ sơ đã xác thực</span>
                                <span class="kpi-pill">Chất lượng dữ liệu</span>
                            </div>
                            <div class="kpi-value">
                                <t t-esc="formatNumber(state.kpiData.verified_percentage, 0)"/>%
                            </div>
                            <div class="kpi-sub">Số hồ sơ trạng thái "Đã xác thực"</div>
                        </div>

                        <div class="kpi-card">
                            <div class="kpi-label">
                                <span>% Hạn ngạch đã sử dụng</span>
                                <span class="kpi-pill">Quota</span>
                            </div>
                            <div class="kpi-value">
                                <t t-esc="formatNumber(state.kpiData.quota_utilization, 1)"/>%
                            </div>
                            <div class="kpi-sub">Form 02 - Mức sử dụng so với phân bổ</div>
                        </div>

                        <div class="kpi-card">
                            <div class="kpi-label">
                                <span>Tổng khối lượng thu gom</span>
                                <span class="kpi-pill">EoL</span>
                            </div>
                            <div class="kpi-value" t-esc="formatNumber(state.kpiData.total_eol_kg, 0)"/>
                            <div class="kpi-sub">Thu gom + Tái sử dụng + Tái chế + Xử lý</div>
                        </div>
                    </section>

                    <!-- Charts Row -->
                    <section class="grid-row">
                        <div class="panel">
                            <div class="panel-header">
                                <div>
                                    <div class="panel-title">Biểu đồ khối lượng HFC theo năm &amp; chất</div>
                                    <div class="panel-subtitle">Bar chart – Group by: Năm, Tên chất</div>
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas t-ref="barChart"/>
                            </div>
                        </div>

                        <div class="panel">
                            <div class="panel-header">
                                <div>
                                    <div class="panel-title">Cơ cấu hoạt động</div>
                                    <div class="panel-subtitle">Pie chart – SX / NK / XK / Thu gom / Tái chế / Tiêu hủy</div>
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas t-ref="pieChart"/>
                            </div>
                        </div>
                    </section>

                    <!-- Tables Row -->
                    <section class="grid-row-2">

                        <!-- Pivot Table -->
                        <div class="panel">
                            <div class="panel-header">
                                <div>
                                    <div class="panel-title">Báo cáo đa chiều (Pivot)</div>
                                    <div class="panel-subtitle">Rows: DN, Chất • Columns: Năm • Measures: kg, CO₂e</div>
                                </div>
                            </div>
                            <div class="table-wrapper">
                                <table class="table table-sm table-hover">
                                    <thead>
                                        <tr>
                                            <th>Doanh nghiệp</th>
                                            <th>Tên chất</th>
                                            <th class="text-end">2021 (kg)</th>
                                            <th class="text-end">2022 (kg)</th>
                                            <th class="text-end">2023 (kg)</th>
                                            <th class="text-end">2024 (kg)</th>
                                            <th class="text-end">CO₂e (t)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <t t-if="state.pivotData.length === 0">
                                            <tr>
                                                <td colspan="7" class="text-center text-muted">
                                                    <i class="fa fa-info-circle"/> Không có dữ liệu
                                                </td>
                                            </tr>
                                        </t>
                                        <t t-else="">
                                            <t t-foreach="state.pivotData" t-as="row" t-key="row.organization_id + '_' + row.substance_id">
                                                <tr>
                                                    <td>
                                                        <a href="#"
                                                           t-on-click.prevent="() => this.viewOrganization(row.organization_id)"
                                                           class="text-primary"
                                                           t-esc="row.organization_name"/>
                                                    </td>
                                                    <td>
                                                        <a href="#"
                                                           t-on-click.prevent="() => this.viewSubstance(row.substance_id)"
                                                           class="text-primary"
                                                           t-esc="row.substance_name"/>
                                                    </td>
                                                    <td class="text-end" t-esc="formatNumber(row.year_2021_kg, 0)"/>
                                                    <td class="text-end" t-esc="formatNumber(row.year_2022_kg, 0)"/>
                                                    <td class="text-end" t-esc="formatNumber(row.year_2023_kg, 0)"/>
                                                    <td class="text-end" t-esc="formatNumber(row.year_2024_kg, 0)"/>
                                                    <td class="text-end" t-esc="formatNumber(row.total_co2e, 1)"/>
                                                </tr>
                                            </t>
                                        </t>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Top 10 Table -->
                        <div class="panel">
                            <div class="panel-header">
                                <div>
                                    <div class="panel-title">Top 10 hồ sơ theo khối lượng</div>
                                    <div class="panel-subtitle">Danh sách hồ sơ có tổng khối lượng lớn nhất</div>
                                </div>
                            </div>
                            <div class="table-wrapper">
                                <table class="table table-sm table-hover">
                                    <thead>
                                        <tr>
                                            <th>Doanh nghiệp</th>
                                            <th>Chất</th>
                                            <th>Năm</th>
                                            <th class="text-end">Khối lượng (kg)</th>
                                            <th class="text-end">CO₂e (t)</th>
                                            <th>Lĩnh vực</th>
                                            <th>Trạng thái</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <t t-if="state.topRecordsData.length === 0">
                                            <tr>
                                                <td colspan="7" class="text-center text-muted">
                                                    <i class="fa fa-info-circle"/> Không có dữ liệu
                                                </td>
                                            </tr>
                                        </t>
                                        <t t-else="">
                                            <t t-foreach="state.topRecordsData" t-as="record" t-key="record_index">
                                                <tr>
                                                    <td>
                                                        <a href="#"
                                                           t-on-click.prevent="() => this.viewOrganization(record.organization_id)"
                                                           class="text-primary"
                                                           t-esc="record.organization_name"/>
                                                    </td>
                                                    <td>
                                                        <a href="#"
                                                           t-on-click.prevent="() => this.viewSubstance(record.substance_id)"
                                                           class="text-primary"
                                                           t-esc="record.substance_name"/>
                                                    </td>
                                                    <td t-esc="record.year"/>
                                                    <td class="text-end" t-esc="formatNumber(record.total_kg, 0)"/>
                                                    <td class="text-end" t-esc="formatNumber(record.co2e, 1)"/>
                                                    <td>
                                                        <div class="tag-list">
                                                            <t t-foreach="record.activity_tags" t-as="tag" t-key="tag">
                                                                <span class="badge bg-info" t-esc="tag"/>
                                                            </t>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <span t-att-class="'badge ' + getStatusBadgeClass(record.status)"
                                                              t-esc="getStatusLabel(record.status)"/>
                                                    </td>
                                                </tr>
                                            </t>
                                        </t>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                    </section>

                </div>
            </main>

        </div>
    </t>
</templates>

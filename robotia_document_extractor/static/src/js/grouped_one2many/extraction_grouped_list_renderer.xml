<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">

    <!-- Custom List Renderer template with 2-level grouped headers -->
    <!-- Inherits from X2ManyNumberedListRenderer template -->
    <t t-name="robotia_document_extractor.ExtractionGroupedListRenderer" t-inherit="robotia_document_extractor.X2ManyNumberedListRenderer" t-inherit-mode="primary">

        <!-- Replace entire thead when we have grouped headers -->
        <xpath expr="//thead" position="replace">
            <thead>
                <t t-if="hasGroupedHeaders">
                    <!-- Row 1: Non-grouped columns (rowspan=2) + Group headers (colspan) -->
                    <t t-call="robotia_document_extractor.ExtractionGroupedListRenderer.Header">
                        <t t-set="columns" t-value="headerColumns1"/>
                        <t t-set="allowSelectors" t-value="hasSelectors"/>
                        <t t-set="selectorRowspan" t-value="2"/>
                        <t t-set="isRow1" t-value="1"/>
                    </t>
                    <!-- Row 2: Only grouped columns (children) -->
                    <t t-call="robotia_document_extractor.ExtractionGroupedListRenderer.Header">
                        <t t-set="columns" t-value="headerColumns2"/>
                        <t t-set="allowSelectors" t-value="false"/>
                    </t>
                </t>
                <t t-else="">
                    <!-- Standard single-row header (no grouping) -->
                    <t t-call="robotia_document_extractor.ExtractionGroupedListRenderer.Header"/>
                </t>
            </thead>
        </xpath>

    </t>

    <!-- Header template for rendering one header row -->
    <t t-name="robotia_document_extractor.ExtractionGroupedListRenderer.Header">
        <tr>
            <th t-if="isRow1" style="text-align: center;vertical-align: middle;" rowspan="2">#</th>
            <!-- Selector column (checkbox) -->
            <th t-if="allowSelectors"
                t-att-rowspan="selectorRowspan || 1"
                class="o_list_record_selector o_list_controller align-middle pe-1 cursor-pointer"
                tabindex="-1"
                t-on-keydown="(ev) => this.onCellKeydown(ev)"
                t-on-click.stop="toggleSelection">
                <CheckBox disabled="!_canSelectRecord" value="selectAll" className="'d-flex m-0'" onChange.bind="toggleSelection"/>
            </th>

            <!-- Iterate through columns -->
            <t t-foreach="columns || this.columns" t-as="column" t-key="column.id || column.name">

                <!-- Group header (parent header with colspan) -->
                <th t-if="column.type === 'field_group'"
                    t-att-class="column.groupClass"
                    t-att-colspan="column.colspan || 1"
                    t-att-rowspan="column.rowspan || 1">
                    <span class="text-center d-block min-w-0 text-truncate flex-grow-1 flex-shrink-1" t-esc="column.label"/>
                </th>

                <!-- Number index column (#) -->
                <th t-elif="column.type === '__sequence_number__'"
                    t-att-rowspan="column.rowspan || 1"
                    class="text-center fw-bold">
                    <span t-esc="column.label"/>
                </th>

                <!-- Handle column (drag & drop) -->
                <th t-elif="column.widget === 'handle'"
                    t-att-data-name="column.name"
                    t-att-rowspan="column.rowspan || 1"
                    t-att-class="getColumnClass(column) + ' o_handle_cell'"
                    t-on-keydown="(ev) => this.onCellKeydown(ev)"
                    tabindex="-1"/>

                <!-- Button group column -->
                <th t-elif="column.type === 'button_group'"
                    t-att-rowspan="column.rowspan || 1"
                    t-att-class="column.groupClass"
                    class="align-middle">
                    <span class="text-center d-block min-w-0 text-truncate flex-grow-1 flex-shrink-1">
                        Action
                    </span>
                </th>

                <!-- Regular field column -->
                <th t-elif="column.type === 'field'"
                    t-att-data-name="column.name"
                    t-att-class="getColumnClass(column) + ' opacity-trigger-hover w-print-auto'"
                    t-on-pointerup="onColumnTitleMouseUp"
                    t-on-click="() => this.onClickSortColumn(column)"
                    t-on-keydown="(ev) => this.onCellKeydown(ev)"
                    data-tooltip-delay="1000"
                    t-att-colspan="column.colspan || 1"
                    t-att-rowspan="column.rowspan || 1"
                    tabindex="-1">
                    <t t-if="column.hasLabel and column.widget !== 'handle'">
                        <t t-set="isNumeric" t-value="isNumericColumn(column)"/>
                        <div class="d-flex"
                            t-att-data-tooltip-template="isDebugMode ? 'web.FieldTooltip' : 'web.ListHeaderTooltip'"
                            t-att-data-tooltip-info="makeTooltip(column)">
                            <span class="d-block min-w-0 text-truncate flex-grow-1 flex-shrink-1"
                                  t-att-class="isNumeric ? 'o_list_number_th' : ''"
                                  t-esc="column.label"/>
                            <div class="o_list_header_label_spacer"/>
                            <i class="o_list_sortable_caret" t-att-class="getSortableIconClass(column)"/>
                        </div>
                        <span class="o_resize position-absolute top-0 end-0 bottom-0 ps-1 bg-black-25 opacity-0 opacity-50-hover z-1"
                              t-on-pointerdown.stop.prevent="this.columnWidths.onStartResize"/>
                    </t>
                </th>
            </t>

            <!-- Actions column (only in row 1 when grouped, always when not grouped) -->
            <th t-if="hasActionsColumn and (!hasGroupedHeaders or isRow1)"
                t-att-rowspan="hasGroupedHeaders ? 2 : 1"
                style="text-align: center;vertical-align: middle;z-index: 19999999;"
                t-on-keydown="(ev) => this.onCellKeydown(ev)"
                class="o_list_controller o_list_actions_header w-print-0 p-print-0 position-sticky end-0">
                <div t-if="displayOptionalFields or hasOptionalOpenFormViewColumn" class="o_optional_columns_dropdown d-print-none text-center border-top-0">
                    <Dropdown position="'bottom-end'">
                        <button class="btn p-0" tabindex="-1">
                            <i class="o_optional_columns_dropdown_toggle oi oi-fw oi-settings-adjust"/>
                        </button>

                        <t t-set-slot="content">
                            <t t-foreach="optionalFieldGroups" t-as="group" t-key="group_index">
                                <div t-if="!group_first" role="separator" class="dropdown-divider"/>
                                <DropdownItem t-if="group.displayName" closingMode="'none'" onSelected="() => this.toggleOptionalFieldGroup(group.id)">
                                    <div class="fw-bold" t-esc="group.displayName"/>
                                </DropdownItem>
                                <t t-foreach="group.optionalFields" t-as="field" t-key="field_index">
                                    <DropdownItem closingMode="'none'" onSelected="() => this.toggleOptionalField(field.name)">
                                        <CheckBox value="field.isDisplayed" onChange="() => this.toggleOptionalField(field.name)">
                                            <t t-esc="field.label"/>
                                        </CheckBox>
                                    </DropdownItem>
                                </t>
                            </t>
                            <DropdownItem t-if="hasOptionalOpenFormViewColumn" closingMode="'none'" onSelected="() => this.toggleOptionalField(OPEN_FORM_VIEW_COLUMN_NAME)">
                                <CheckBox value="optionalActiveFields[OPEN_FORM_VIEW_COLUMN_NAME]" onChange="() => this.toggleOptionalField(OPEN_FORM_VIEW_COLUMN_NAME)">
                                    Open Form View
                                </CheckBox>
                            </DropdownItem>
                        </t>
                    </Dropdown>
                </div>
            </th>
        </tr>
    </t>

</templates>

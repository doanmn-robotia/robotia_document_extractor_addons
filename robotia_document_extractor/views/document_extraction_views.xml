<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Form View with Split Layout and PDF Preview -->
    <record id="view_document_extraction_form" model="ir.ui.view">
        <field name="name">document.extraction.form</field>
        <field name="model">document.extraction</field>
        <field name="arch" type="xml">
            <form string="Document Extraction"
                  js_class="document_extraction_form"
                  class="o_form_extraction_split">
                <header>
                    <field name="state" widget="statusbar" statusbar_visible="draft,validated,completed" options="{'clickable': '1'}"/>
                </header>

                <sheet>
                    <!-- Smart Buttons -->
                    <div class="oe_button_box" name="button_box">
                        <button name="action_view_extraction_log" type="object"
                                class="oe_stat_button" icon="fa-history"
                                invisible="not extraction_log_id">
                            <field name="extraction_log_id" invisible="1"/>
                            <div class="o_stat_info">
                                <span class="o_stat_text">Extraction</span>
                                <span class="o_stat_text">Log</span>
                            </div>
                        </button>
                    </div>

                    <!-- Document Metadata -->
                    <div class="oe_title">
                        <h1>
                            <field name="name" placeholder="Document Name" readonly="1"/>
                        </h1>
                    </div>

                    <group>
                        <group>
                            <field name="document_type" required="1"/>
                            <field name="year" required="1" options="{'enable_formatting': false}"/>
                            <field name="extraction_date" readonly="1"/>
                            <field name="source"/>
                        </group>
                        <group>
                            <field name="ocr_status" invisible="1"/>
                            <field name="ocr_error_message" invisible="ocr_status != 'error'" readonly="1"/>
                            <field name="gdrive_file_id" invisible="source != 'from_external_source'" readonly="1"/>
                            <field name="pdf_filename" invisible="1"/>
                            <field name="state" invisible="1"/>
                        </group>
                    </group>

                    <group string="Year Information (Table Columns)" invisible="1">
                        <group>
                            <field name="year_1" options="{'enable_formatting': false}"/>
                            <field name="year_2" options="{'enable_formatting': false}"/>
                        </group>
                        <group>
                            <field name="year_3" options="{'enable_formatting': false}"/>
                        </group>
                    </group>

                    <notebook>
                        <!-- Page 2: Organization Information (4.1.1 & 4.2.1) -->
                        <page string="Organization Info" name="organization_info">
                            <group>
                                <group string="Organization Details" colspan="2">
                                    <field name="organization_id"
                                           domain="[('x_partner_type', '=', 'organization')]"
                                           context="{'form_view_ref': 'robotia_document_extractor.view_partner_organization_form', 'tree_view_ref': 'robotia_document_extractor.view_partner_organization_list', 'default_x_partner_type': 'organization'}"/>
                                    <field name="organization_name" required="1"/>
                                    <field name="business_license_number"/>
                                    <field name="business_license_date"/>
                                    <field name="business_license_place"/>
                                </group>
                                <group string="Representative Information" colspan="2">
                                    <field name="legal_representative_name"/>
                                    <field name="legal_representative_position"/>
                                    <field name="contact_person_name"/>
                                </group>
                            </group>
                            <group>
                                <group string="Contact Details" colspan="2">
                                    <field name="contact_address"/>
                                    <field name="contact_country_id"/>
                                    <field name="contact_state_id" domain="[('country_id', '=', contact_country_id)]"/>
                                    <field name="contact_phone"/>
                                    <field name="contact_fax"/>
                                    <field name="contact_email" widget="email"/>
                                </group>
                            </group>
                            <group string="Registration Tables (Form 01 only)" invisible="1">
                                <group>
                                    <field name="has_table_1_1"/>
                                    <field name="has_table_1_2"/>
                                </group>
                                <group>
                                    <field name="has_table_1_3"/>
                                    <field name="has_table_1_4"/>
                                </group>
                            </group>
                            <group string="Report Tables (Form 02 only)" invisible="1">
                                <group>
                                    <field name="has_table_2_1"/>
                                    <field name="has_table_2_2"/>
                                </group>
                                <group>
                                    <field name="has_table_2_3"/>
                                    <field name="has_table_2_4"/>
                                </group>
                            </group>
                        </page>

                        <!-- Page 1: Registration Content (Section 2 in Form 01) -->
                        <page string="Registration Content" name="registration_content" invisible="document_type != '01'">
                            <field name="activity_field_ids" nolabel="1">
                                <list>
                                    <field name="name"/>
                                </list>
                            </field>
                        </page>

                        <page string="Scope of operation" name="scope_of_operation" invisible="document_type != '02'">
                            <field name="activity_field_ids" nolabel="1">
                                <list>
                                    <field name="name"/>
                                </list>
                            </field>
                        </page>

                        <!-- Page 2: Table 1.1 - Substance Usage (Production, Import, Export) -->
                        <page string="Table 1.1: Substance Usage" name="table_1_1"
                              invisible="document_type != '01' or not has_table_1_1">
                            <field name="substance_usage_ids" widget="extraction_grouped_one2many"
                                   options="{
                                       'titleField': 'substance_name',
                                       'group_columns': {
                                           'year_1': ['year_1_quantity_kg', 'year_1_quantity_co2'],
                                           'year_2': ['year_2_quantity_kg', 'year_2_quantity_co2'],
                                           'year_3': ['year_3_quantity_kg', 'year_3_quantity_co2']
                                       }
                                   }"
                                   nolabel="1">
                                <list editable="bottom">
                                    <field name="sequence" widget="handle" options="{'enable_formatting': false}"/>
                                    <field name="substance_name" column_invisible="1"/>
                                    <field name="substance_id" widget="extraction_title_field" options="{'no_quick_create': True}"/>
                                    <field name="year_1_quantity_kg" string="Quantity (Kg)" options="{'enable_formatting': false}"/>
                                    <field name="year_1_quantity_co2" string="Quantity (ton CO2tđ)" options="{'enable_formatting': false}"/>
                                    <field name="year_2_quantity_kg" string="Quantity (Kg)" options="{'enable_formatting': false}"/>
                                    <field name="year_2_quantity_co2" string="Quantity (ton CO2tđ)" options="{'enable_formatting': false}"/>
                                    <field name="year_3_quantity_kg" string="Quantity (Kg)" options="{'enable_formatting': false}"/>
                                    <field name="year_3_quantity_co2" string="Quantity (ton CO2tđ)" options="{'enable_formatting': false}"/>
                                    <field name="avg_quantity_kg" options="{'enable_formatting': false}"/>
                                    <field name="avg_quantity_co2" options="{'enable_formatting': false}"/>
                                    <field name="is_title" column_invisible="1"/>
                                    <field name="usage_type" column_invisible="1"/>
                                    <control>
                                        <create name="add_data_control" string="Add substance"/>
                                        <create name="add_section_control" string="Add section title"
                                                context="{'default_is_title': True, 'default_sequence': 1}"/>
                                    </control>
                                </list>
                            </field>
                        </page>

                        <!-- Page 3: Table 1.2 - Equipment/Product Info -->
                        <page string="Table 1.2: Equipment/Product" name="table_1_2"
                              invisible="document_type != '01' or not has_table_1_2">
                            <field name="equipment_product_ids" widget="extraction_section_one2many" options="{'titleField': 'product_type'}" nolabel="1">
                                <list editable="bottom">
                                    <field name="sequence" widget="handle" options="{'enable_formatting': false}"/>
                                    <field name="product_type" widget="extraction_title_field"/>
                                    <field name="hs_code"/>
                                    <field name="capacity" column_invisible="not parent.is_capacity_merged_table_1_2"/>
                                    <field name="cooling_capacity" column_invisible="parent.is_capacity_merged_table_1_2"/>
                                    <field name="power_capacity" column_invisible="parent.is_capacity_merged_table_1_2"/>
                                    <field name="quantity" options="{'enable_formatting': false}"/>
                                    <field name="substance_id" required="1" options="{'no_quick_create': True}"/>
                                    <field name="substance_quantity_per_unit" options="{'enable_formatting': false}"/>
                                    <field name="notes"/>
                                    <field name="is_title" column_invisible="1"/>
                                    <control>
                                        <create name="add_data_control" string="Add equipment/product"/>
                                        <create name="add_section_control" string="Add section title"
                                                context="{'default_is_title': True, 'default_sequence': 1}"/>
                                    </control>
                                </list>
                            </field>
                        </page>

                        <!-- Page 4: Table 1.3 - Equipment Ownership -->
                        <page string="Table 1.3: Equipment Ownership" name="table_1_3"
                              invisible="document_type != '01' or not has_table_1_3">
                            <field name="equipment_ownership_ids" widget="extraction_section_one2many" options="{'titleField': 'equipment_type'}" nolabel="1">
                                <list editable="bottom">
                                    <field name="sequence" widget="handle" options="{'enable_formatting': false}"/>
                                    <field name="equipment_type" widget="extraction_title_field"/>
                                    <field name="start_year" options="{'enable_formatting': false}"/>
                                    <field name="capacity" column_invisible="not parent.is_capacity_merged_table_1_3"/>
                                    <field name="cooling_capacity" column_invisible="parent.is_capacity_merged_table_1_3"/>
                                    <field name="power_capacity" column_invisible="parent.is_capacity_merged_table_1_3"/>
                                    <field name="substance_id" required="1" options="{'no_quick_create': True}"/>
                                    <field name="equipment_quantity" options="{'enable_formatting': false}"/>
                                    <field name="refill_frequency" options="{'enable_formatting': false}"/>
                                    <field name="substance_quantity_per_refill" options="{'enable_formatting': false}"/>
                                    <field name="is_title" column_invisible="1"/>
                                    <control>
                                        <create name="add_data_control" string="Add equipment"/>
                                        <create name="add_section_control" string="Add section title"
                                                context="{'default_is_title': True, 'default_sequence': 1}"/>
                                    </control>
                                </list>
                            </field>
                        </page>

                        <!-- Page 5: Table 1.4 - Collection, Recycling, Reuse, Disposal -->
                        <page string="Table 1.4: Collection &amp; Recycling" name="table_1_4"
                              invisible="document_type != '01' or not has_table_1_4">
                            <field name="collection_recycling_ids" widget="extraction_section_one2many" options="{'titleField': 'substance_name'}" nolabel="1">
                                <list editable="bottom">
                                    <field name="sequence" widget="handle" options="{'enable_formatting': false}"/>
                                    <field name="activity_type" column_invisible="1"/>
                                    <field name="substance_name" column_invisible="1"/>
                                    <field name="substance_id" required="1" widget="extraction_title_field" options="{'no_quick_create': True}"/>
                                    <field name="quantity_kg" options="{'enable_formatting': false}"/>
                                    <field name="quantity_co2" options="{'enable_formatting': false}"/>
                                    <field name="is_title" column_invisible="1"/>
                                    <control>
                                        <create name="add_data_control" string="Add substance"/>
                                        <create name="add_section_control" string="Add section title"
                                                context="{'default_is_title': True, 'default_sequence': 1}"/>
                                    </control>
                                </list>
                            </field>
                        </page>

                        <!-- Page 6: Table 2.1 - Quota Usage Report (Form 02 only) -->
                        <page string="Table 2.1: Quota Usage" name="table_2_1"
                              invisible="document_type != '02' or not has_table_2_1">
                            <field name="quota_usage_ids" widget="extraction_section_one2many" options="{'titleField': 'substance_name'}" nolabel="1">
                                <list editable="bottom">
                                    <field name="sequence" widget="handle" options="{'enable_formatting': false}"/>
                                    <field name="substance_name" column_invisible="1"/>
                                    <field name="substance_id" required="1" widget="extraction_title_field" options="{'no_quick_create': True}"/>
                                    <field name="hs_code"/>
                                    <field name="allocated_quota_kg" options="{'enable_formatting': false}"/>
                                    <field name="allocated_quota_co2" options="{'enable_formatting': false}"/>
                                    <field name="adjusted_quota_kg" options="{'enable_formatting': false}"/>
                                    <field name="adjusted_quota_co2" options="{'enable_formatting': false}"/>
                                    <field name="total_quota_kg" options="{'enable_formatting': false}"/>
                                    <field name="total_quota_co2" options="{'enable_formatting': false}"/>
                                    <field name="average_price" options="{'enable_formatting': false}"/>
                                    <field name="country_text"/>
                                    <field name="customs_declaration_number"/>
                                    <field name="next_year_quota_kg" options="{'enable_formatting': false}"/>
                                    <field name="next_year_quota_co2" options="{'enable_formatting': false}"/>
                                    <field name="is_title" column_invisible="1"/>
                                    <field name="usage_type" column_invisible="1"/>
                                    <control>
                                        <create name="add_data_control" string="Add substance"/>
                                        <create name="add_section_control" string="Add section title"
                                                context="{'default_is_title': True, 'default_sequence': 1}"/>
                                    </control>
                                </list>
                            </field>
                        </page>

                        <!-- Page 7: Table 2.2 - Same as Table 1.2 for Form 02 -->
                        <page string="Table 2.2: Equipment/Product Report" name="table_2_2"
                              invisible="document_type != '02' or not has_table_2_2">
                            <field name="equipment_product_report_ids" widget="extraction_section_one2many" options="{'titleField': 'product_type'}" nolabel="1">
                                <list editable="bottom">
                                    <field name="sequence" widget="handle" options="{'enable_formatting': false}"/>
                                    <field name="product_type" widget="extraction_title_field"/>
                                    <field name="hs_code"/>
                                    <field name="capacity" column_invisible="not parent.is_capacity_merged_table_2_2"/>
                                    <field name="cooling_capacity" column_invisible="parent.is_capacity_merged_table_2_2"/>
                                    <field name="power_capacity" column_invisible="parent.is_capacity_merged_table_2_2"/>
                                    <field name="quantity" options="{'enable_formatting': false}"/>
                                    <field name="substance_id" required="1" options="{'no_quick_create': True}"/>
                                    <field name="substance_quantity_per_unit" options="{'enable_formatting': false}"/>
                                    <field name="notes"/>
                                    <field name="is_title" column_invisible="1"/>
                                    <field name="production_type" column_invisible="1"/>
                                    <control>
                                        <create name="add_data_control" string="Add equipment/product"/>
                                        <create name="add_section_control" string="Add section title"
                                                context="{'default_is_title': True, 'default_sequence': 1}"/>
                                    </control>
                                </list>
                            </field>
                        </page>

                        <!-- Page 8: Table 2.3 - Equipment Ownership Report (Form 02) -->
                        <page string="Table 2.3: Equipment Report" name="table_2_3"
                              invisible="document_type != '02' or not has_table_2_3">
                            <field name="equipment_ownership_report_ids" widget="extraction_section_one2many" options="{'titleField': 'equipment_type'}" nolabel="1">
                                <list editable="bottom">
                                    <field name="sequence" widget="handle" options="{'enable_formatting': false}"/>
                                    <field name="equipment_type" widget="extraction_title_field"/>
                                    <field name="equipment_quantity" options="{'enable_formatting': false}"/>
                                    <field name="substance_id" required="1" options="{'no_quick_create': True}"/>
                                    <field name="capacity" column_invisible="not parent.is_capacity_merged_table_2_3"/>
                                    <field name="cooling_capacity" column_invisible="parent.is_capacity_merged_table_2_3"/>
                                    <field name="power_capacity" column_invisible="parent.is_capacity_merged_table_2_3"/>
                                    <field name="start_year" options="{'enable_formatting': false}"/>
                                    <field name="refill_frequency" options="{'enable_formatting': false}"/>
                                    <field name="substance_quantity_per_refill" options="{'enable_formatting': false}"/>
                                    <field name="notes"/>
                                    <field name="is_title" column_invisible="1"/>
                                    <field name="ownership_type" column_invisible="1"/>
                                    <control>
                                        <create name="add_data_control" string="Add equipment"/>
                                        <create name="add_section_control" string="Add section title"
                                                context="{'default_is_title': True, 'default_sequence': 1}"/>
                                    </control>
                                </list>
                            </field>
                        </page>

                        <!-- Page 9: Table 2.4 - Collection & Recycling Report (Complex structure) -->
                        <page string="Table 2.4: Collection &amp; Recycling Report" name="table_2_4"
                              invisible="document_type != '02' or not has_table_2_4">
                            <field widget="x2many_no_magic_width_list" name="collection_recycling_report_ids">
                                <list editable="bottom">
                                    <field name="substance_id" required="1" options="{'no_create': True, 'no_quick_create': True}"/>
                                    <!-- Collection -->
                                    <field name="collection_quantity_kg" options="{'enable_formatting': false}"/>
                                    <field name="collection_location"/>
                                    <field name="storage_location"/>
                                    <!-- Reuse -->
                                    <field name="reuse_quantity_kg" options="{'enable_formatting': false}"/>
                                    <field name="reuse_technology"/>
                                    <!-- Recycle -->
                                    <field name="recycle_quantity_kg" options="{'enable_formatting': false}"/>
                                    <field name="recycle_technology"/>
                                    <field name="recycle_usage_location"/>
                                    <!-- Disposal -->
                                    <field name="disposal_quantity_kg" options="{'enable_formatting': false}"/>
                                    <field name="disposal_technology"/>
                                    <field name="disposal_facility"/>
                                </list>
                            </field>
                        </page>
                    </notebook>
                </sheet>

                <!-- PDF Preview Container (will be extracted by FormCompiler) -->
                <div class="o_pdf_preview">
                    <notebook>
                        <page name="name" string="PDF Document Preview">
                            <div class="o_pdf_preview_content">
                                <field name="id" invisible="1"/>
                                <field name="pdf_attachment_id" invisible="1"/>
                                <field name="pdf_file" widget="pdf_viewer" invisible="not id" options="{'height': '100%'}"/>
                                <field name="pdf_url" widget="pdf_url_viewer" invisible="id"/>
                            </div>
                        </page>
                        <page name="json" string="Json" invisible="not extraction_log_json">
                            <field name="extraction_log_json" options="{'mode': 'python'}" widget="ace_copy"/>
                        </page>
                    </notebook>
                </div>
            </form>
        </field>
    </record>

    <!-- List View (using <list/> not <tree/>) -->
    <record id="view_document_extraction_list" model="ir.ui.view">
        <field name="name">document.extraction.list</field>
        <field name="model">document.extraction</field>
        <field name="arch" type="xml">
            <list string="Document Extractions">
                <field name="name"/>
                <field name="document_type"/>
                <field name="organization_id"/>
                <field name="year" options="{'enable_formatting': false}"/>
                <field name="year_1" optional="hide" options="{'enable_formatting': false}"/>
                <field name="year_2" optional="hide" options="{'enable_formatting': false}"/>
                <field name="year_3" optional="hide" options="{'enable_formatting': false}"/>
                <field name="source"/>
                <field name="ocr_status" column_invisible="1"
                       decoration-muted="ocr_status == 'pending'"
                       decoration-warning="ocr_status == 'processing'"
                       decoration-success="ocr_status == 'completed'"
                       decoration-danger="ocr_status == 'error'"/>
                <field name="extraction_date"/>
                <field name="state" widget="badge" decoration-info="state == 'draft'"
                       decoration-warning="state == 'validated'"
                       decoration-success="state == 'completed'"/>
            </list>
        </field>
    </record>

    <!-- Search View with Filters -->
    <record id="view_document_extraction_search" model="ir.ui.view">
        <field name="name">document.extraction.search</field>
        <field name="model">document.extraction</field>
        <field name="arch" type="xml">
            <search string="Search Document Extractions">
                <!-- Search Fields - Basic Info -->
                <field name="name"/>
                <field name="document_type"/>
                <field name="year" options="{'enable_formatting': false}"/>
                <field name="state"/>
                <field name="source"/>
                <field name="ocr_status" invisible="1"/>
                <field name="extraction_date"/>

                <!-- Search Fields - Organization -->
                <field name="organization_id"/>
                <field name="organization_name"/>
                <field name="business_license_number"/>
                <field name="business_license_place"/>
                <field name="legal_representative_name"/>
                <field name="legal_representative_position"/>
                <field name="contact_person_name"/>
                <field name="contact_address"/>
                <field name="contact_email"/>
                <field name="contact_phone"/>
                <field name="contact_fax"/>

                <!-- Search Fields - Related Data (Form 01) -->
                <field name="substance_usage_ids" string="Substance Usage"
                       filter_domain="[('substance_usage_ids.substance_name', 'ilike', self)]"/>
                <field name="equipment_product_ids" string="Equipment/Product"
                       filter_domain="['|', '|', ('equipment_product_ids.product_type', 'ilike', self), ('equipment_product_ids.substance_name', 'ilike', self), ('equipment_product_ids.hs_code', 'ilike', self)]"/>
                <field name="equipment_ownership_ids" string="Equipment Ownership"
                       filter_domain="['|', ('equipment_ownership_ids.equipment_type', 'ilike', self), ('equipment_ownership_ids.substance_name', 'ilike', self)]"/>
                <field name="collection_recycling_ids" string="Collection/Recycling"
                       filter_domain="[('collection_recycling_ids.substance_name', 'ilike', self)]"/>

                <!-- Search Fields - Related Data (Form 02) -->
                <field name="quota_usage_ids" string="Quota Usage"
                       filter_domain="['|', ('quota_usage_ids.substance_name', 'ilike', self), ('quota_usage_ids.hs_code', 'ilike', self)]"/>
                <field name="equipment_product_report_ids" string="Equipment/Product Report"
                       filter_domain="['|', '|', ('equipment_product_report_ids.product_type', 'ilike', self), ('equipment_product_report_ids.substance_name', 'ilike', self), ('equipment_product_report_ids.hs_code', 'ilike', self)]"/>
                <field name="equipment_ownership_report_ids" string="Equipment Ownership Report"
                       filter_domain="['|', ('equipment_ownership_report_ids.equipment_type', 'ilike', self), ('equipment_ownership_report_ids.substance_name', 'ilike', self)]"/>
                <field name="collection_recycling_report_ids" string="Collection/Recycling Report"
                       filter_domain="[('collection_recycling_report_ids.substance_name', 'ilike', self)]"/>

                <!-- Search Fields - Activity Fields -->
                <field name="activity_field_ids" string="Activity Field"/>

                <!-- Filters -->
                <filter string="Registration (Form 01)" name="filter_form_01"
                        domain="[('document_type', '=', '01')]"/>
                <filter string="Report (Form 02)" name="filter_form_02"
                        domain="[('document_type', '=', '02')]"/>

                <separator/>

                <filter string="Draft" name="filter_draft"
                        domain="[('state', '=', 'draft')]"/>
                <filter string="Validated" name="filter_validated"
                        domain="[('state', '=', 'validated')]"/>
                <filter string="Completed" name="filter_completed"
                        domain="[('state', '=', 'completed')]"/>

                <separator/>

                <filter string="User Upload" name="filter_user_upload"
                        domain="[('source', '=', 'from_user_upload')]"/>
                <filter string="External Source (Google Drive)" name="filter_external_source"
                        domain="[('source', '=', 'from_external_source')]"/>

                <separator/>

                <filter string="This Year" name="filter_this_year"
                        domain="[('year', '=', context_today().year)]"/>

                <!-- Group By -->
                <group expand="1" string="Group By">
                    <filter string="Document Type" name="group_document_type"
                            context="{'group_by': 'document_type'}"/>
                    <filter string="Year" name="group_year"
                            context="{'group_by': 'year'}"/>
                    <filter string="Organization" name="group_organization"
                            context="{'group_by': 'organization_id'}"/>
                    <filter string="State" name="group_state"
                            context="{'group_by': 'state'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Window Actions -->
    <record id="action_document_extraction_all" model="ir.actions.act_window">
        <field name="name">All Documents</field>
        <field name="res_model">document.extraction</field>
        <field name="view_mode">list,form</field>
        <field name="context">{'search_default_group_document_type': 1, 'expand': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No documents extracted yet
            </p>
            <p>
                Upload PDF documents to extract data automatically using AI.
            </p>
        </field>
    </record>

    <record id="action_document_extraction_registration" model="ir.actions.act_window">
        <field name="name">Registrations (Form 01)</field>
        <field name="res_model">document.extraction</field>
        <field name="view_mode">list,form</field>
        <field name="domain">[('document_type', '=', '01')]</field>
        <field name="context">{'default_document_type': '01', 'search_default_filter_form_01': 1}</field>
    </record>

    <record id="action_document_extraction_report" model="ir.actions.act_window">
        <field name="name">Reports (Form 02)</field>
        <field name="res_model">document.extraction</field>
        <field name="view_mode">list,form</field>
        <field name="domain">[('document_type', '=', '02')]</field>
        <field name="context">{'default_document_type': '02', 'search_default_filter_form_02': 1}</field>
    </record>
</odoo>

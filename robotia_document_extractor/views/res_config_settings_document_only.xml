<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <record id="view_document_extractor_config_form_standalone" model="ir.ui.view">
        <field name="name">document.extractor.config.form.standalone</field>
        <field name="model">res.config.settings</field>
        <field name="priority">1000</field>
        <field name="arch" type="xml">
            <form string="Document Extractor Settings" class="oe_form_configuration" js_class="base_settings">
                <div class="app_settings_block">
                    <block title="AI Configuration">
                        <!-- Core API Keys -->
                        <setting id="gemini_api_key_setting"
                                 help="Configure your Google Gemini API key for AI-powered document extraction">
                            <field name="gemini_api_key" password="True" placeholder="AIza..." class="oe_inline"/>
                            <div class="content-group mt8">
                                <div class="text-muted">
                                    Get your API key from <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a>
                                </div>
                            </div>
                        </setting>

                        <setting id="llama_cloud_api_key_setting"
                                 string="LlamaCloud API Key"
                                 help="Configure your LlamaCloud API key for OCR extraction with bounding boxes">
                            <field name="llama_cloud_api_key" password="True" placeholder="llx-..." class="oe_inline"/>
                            <div class="content-group mt8">
                                <div class="text-muted">
                                    Get your API key from <a href="https://cloud.llamaindex.ai/" target="_blank">LlamaCloud Console</a>
                                </div>
                            </div>
                        </setting>

                        <!-- Extraction Strategy -->
                        <setting id="extraction_strategy_setting"
                                 string="Extraction Strategy"
                                 help="Choose how PDF documents are processed for extraction"
                                 invisible="1">
                            <field name="extraction_strategy" widget="radio" class="o_light_label"/>
                            <div class="content-group mt8">
                                <div class="text-muted">
                                    <strong>100% AI (Recommended):</strong> Gemini processes PDF directly, understanding layout and structure.<br/>
                                    <strong>Text Extract + AI:</strong> Extract text first with PyMuPDF, then structure with AI. May be faster for very large PDFs.<br/>
                                    <strong>Batch Extraction:</strong> Convert PDF to images, process in batches with adaptive sizing. Best for very large documents (20+ pages).
                                </div>
                            </div>
                        </setting>

                        <!-- Gemini Core Configuration -->
                        <setting id="gemini_model_setting"
                                 string="Gemini Model"
                                 help="Select the Gemini model to use for extraction. Different models have different capabilities and costs."
                                >
                            <field name="gemini_model" class="oe_inline" placeholder="gemini-2.5-pro"/>
                            <div class="content-group mt8">
                                <div class="text-muted">
                                    Available models: gemini-3-pro-preview, gemini-2.5-pro
                                    <br/>
                                    See <a href="https://ai.google.dev/gemini-api/docs/models/gemini" target="_blank">Gemini Models documentation</a> for details.
                                </div>
                            </div>
                        </setting>

                        <setting id="gemini_max_output_tokens_setting"
                                 string="Max Output Tokens"
                                 help="Maximum number of tokens for Gemini API response. Increase if extraction fails for very long documents."
                                 invisible="1">
                            <field name="gemini_max_output_tokens" class="oe_inline"/>
                            <div class="content-group mt8">
                                <div class="text-muted">
                                    Recommended: 65536 (maximum for Gemini 2.0 Flash). Reduce if you want to limit API costs.
                                </div>
                            </div>
                        </setting>

                        <setting id="gemini_max_retries_setting"
                                 string="Max Retries"
                                 help="Maximum retry attempts when Gemini API extraction fails. Retries are executed immediately without delay."
                                 invisible="1">
                            <field name="gemini_max_retries" class="oe_inline"/>
                            <div class="content-group mt8">
                                <div class="text-muted">
                                    Default: 3 retries executed immediately. Increase for unreliable API responses.
                                </div>
                            </div>
                        </setting>

                        <!-- Gemini Advanced Parameters -->
                        <setting id="gemini_temperature_setting"
                                 string="Temperature"
                                 help="Controls randomness in Gemini output. 0.0 = fully deterministic (recommended for accuracy)."
                                 >
                            <field name="gemini_temperature"/>
                            <div class="content-group mt8">
                                <div class="text-muted">
                                    <strong>0.0:</strong> Fully deterministic (recommended for data extraction)<br/>
                                    <strong>0.1-0.3:</strong> Low randomness, consistent results<br/>
                                    <strong>0.5-1.0:</strong> Higher creativity (NOT recommended)
                                </div>
                            </div>
                        </setting>

                        <setting id="gemini_top_p_setting"
                                 string="Top P (Nucleus Sampling)"
                                 help="Controls diversity by limiting token selection. 0.95 = consider top 95% probability mass (recommended)."
                                 >
                            <field name="gemini_top_p"/>
                            <div class="content-group mt8">
                                <div class="text-muted">
                                    <strong>0.95:</strong> Recommended - considers top 95% probability tokens<br/>
                                    <strong>1.0:</strong> Maximum flexibility - considers all tokens<br/>
                                    <strong>&lt;0.8:</strong> May miss rare but accurate tokens
                                </div>
                            </div>
                        </setting>

                        <setting id="gemini_top_k_setting"
                                 string="Top K"
                                 help="Limits vocabulary to top K tokens. 0 = no limit (recommended for precision)."
                                 >
                            <field name="gemini_top_k"/>
                            <div class="content-group mt8">
                                <div class="text-muted">
                                    <strong>0:</strong> No limit (recommended for maximum accuracy with specialized terms)<br/>
                                    <strong>40:</strong> Only consider 40 most likely tokens<br/>
                                    Set to 0 for precision with rare/specialized terms
                                </div>
                            </div>
                        </setting>
                    </block>

                    <!-- Batch Extraction Configuration -->
                    <block title="Batch Extraction Configuration" invisible="1">
                        <setting id="batch_size_min_setting"
                                 string="Minimum Batch Size"
                                 help="Minimum pages per API call for complex documents with many table rows">
                            <field name="batch_size_min" class="oe_inline"/>
                            <div class="content-group mt8">
                                <div class="text-muted">
                                    For documents with many tables (complex): process fewer pages per API call for better accuracy.
                                    Recommended: 3 pages.
                                </div>
                            </div>
                        </setting>
                        <setting id="batch_size_max_setting"
                                 string="Maximum Batch Size"
                                 help="Maximum pages per API call for simple documents with few table rows">
                            <field name="batch_size_max" class="oe_inline"/>
                            <div class="content-group mt8">
                                <div class="text-muted">
                                    For simple documents: process more pages per API call for efficiency.
                                    Recommended: 7 pages.
                                </div>
                            </div>
                        </setting>
                        <setting id="batch_image_dpi_setting"
                                 string="Image Resolution (DPI)"
                                 help="Resolution when converting PDF to images">
                            <field name="batch_image_dpi" class="oe_inline"/>
                            <div class="content-group mt8">
                                <div class="text-muted">
                                    Higher DPI = better image quality but larger file sizes and longer processing time.
                                    Recommended range: 150-300 DPI. Default: 200 DPI.
                                </div>
                            </div>
                        </setting>
                    </block>

                    <block title="AI Extraction Prompts Configuration" invisible="1">
                        <setting id="extraction_prompts_setting" string="Direct Extraction Prompts">
                            <div class="d-flex gap-2">
                                <button string="Get Register Prompt" name="action_get_prompt_form_01" type="object" class="btn btn-outline-primary"/>
                                <button string="Get Report Prompt" name="action_get_prompt_form_02" type="object" class="btn btn-outline-primary"/>
                            </div>
                            <div class="content-group mt8">
                                <div class="text-muted">
                                    Reset prompts for direct extraction strategies (100% AI and Text Extract + AI).
                                </div>
                            </div>
                        </setting>
                        <setting id="batch_extraction_prompts_setting"
                                 string="Batch Extraction Prompts"
                                 invisible="extraction_strategy != 'batch_extract'">
                            <div class="d-flex gap-2">
                                <button string="Get Batch Register Prompt" name="action_get_batch_prompt_form_01" type="object" class="btn btn-outline-primary"/>
                                <button string="Get Batch Report Prompt" name="action_get_batch_prompt_form_02" type="object" class="btn btn-outline-primary"/>
                            </div>
                            <div class="content-group mt8">
                                <div class="text-muted">
                                    Reset prompts for batch extraction strategy. These prompts are optimized for per-page extraction with context memory.
                                </div>
                            </div>
                        </setting>
                    </block>

                    <block title="Google Drive Integration">
                        <!-- Enable Google Drive Toggle -->
                        <setting id="google_drive_enabled_setting"
                                 string="Enable Google Drive"
                                 help="Enable automatic document extraction from Google Drive folders">
                            <div class="col-12 col-lg-12 o_setting_box">
                                <div class="o_setting_left_pane">
                                    <field name="google_drive_enabled"/>
                                </div>
                                <div class="o_setting_right_pane">
                                    <label for="google_drive_enabled" string="Enable Google Drive Integration"/>
                                    <div class="text-muted">
                                        Automatically scan and extract PDFs from configured Google Drive folders
                                    </div>
                                </div>
                            </div>
                        </setting>

                        <!-- Configuration Section (visible when enabled) -->
                        <div invisible="not google_drive_enabled" class="mt16">
                            <!-- Hidden field that triggers recompute when JSON changes -->
                            <field name="google_drive_service_account_json" invisible="1"/>
                            <field name="google_drive_configured" invisible="1"/>

                            <!-- STEP 1: Upload Service Account JSON -->
                            <setting id="service_account_upload_setting"
                                     string="Step 1: Service Account"
                                     help="Upload the JSON key file from Google Cloud Console">
                                <div class="row">
                                    <label class="col-lg-3 o_light_label" string="Upload JSON File"/>
                                    <div class="col-lg-9">
                                        <!-- Current status -->
                                        <field name="google_drive_service_account_email" readonly="1"
                                               invisible="not google_drive_service_account_email"
                                               class="mb-2 text-success fw-bold"/>

                                        <!-- File upload -->
                                        <field name="google_drive_service_account_file"
                                               filename="google_drive_service_account_filename"
                                               widget="binary"
                                               class="mb-2"/>
                                        <field name="google_drive_service_account_filename" invisible="1"/>

                                        <!-- Upload button -->
                                        <button string="Upload &amp; Validate"
                                                name="action_upload_service_account_json"
                                                type="object"
                                                class="btn btn-primary mt-2"
                                                icon="fa-upload"
                                                invisible="not google_drive_service_account_file"/>
                                    </div>
                                </div>

                                <!-- Status badges -->
                                <div class="row mt-2" invisible="not google_drive_configured">
                                    <div class="col-lg-9 offset-lg-3">
                                        <div class="alert alert-success mb-0">
                                            <i class="fa fa-check-circle"/> Service account is configured and ready
                                        </div>
                                    </div>
                                </div>
                                <div class="row mt-2" invisible="google_drive_configured">
                                    <div class="col-lg-9 offset-lg-3">
                                        <div class="alert alert-warning mb-0">
                                            <i class="fa fa-exclamation-triangle"/> Service account not configured yet
                                        </div>
                                    </div>
                                </div>
                            </setting>

                            <!-- STEP 2: Folder Configuration -->
                            <setting id="folder_configuration_setting"
                                     string="Step 2: Folder IDs"
                                     help="Configure the 3 Google Drive folder IDs for document management">
                                <div class="row mb-2">
                                    <label class="col-lg-3 o_light_label" for="google_drive_form01_folder_id"/>
                                    <div class="col-lg-9">
                                        <field name="google_drive_form01_folder_id"
                                               placeholder="e.g., 1a2b3c4d5e6f7g8h9i0j"
                                               class="oe_inline"/>
                                    </div>
                                    <span class="col-lg-9 offset-lg-3 text-muted">
                                        Folder for Form 01 (Registration) documents
                                    </span>
                                </div>

                                <div class="row mb-2 mt-3">
                                    <label class="col-lg-3 o_light_label" for="google_drive_form02_folder_id"/>
                                    <div class="col-lg-9">
                                        <field name="google_drive_form02_folder_id"
                                               placeholder="e.g., 1a2b3c4d5e6f7g8h9i0j"
                                               class="oe_inline"/>
                                    </div>
                                    <span class="col-lg-9 offset-lg-3 text-muted">
                                        Folder for Form 02 (Report) documents
                                    </span>
                                </div>

                                <div class="row mb-2 mt-3">
                                    <label class="col-lg-3 o_light_label" for="google_drive_processed_folder_id"/>
                                    <div class="col-lg-9">
                                        <field name="google_drive_processed_folder_id"
                                               placeholder="e.g., 1a2b3c4d5e6f7g8h9i0j"
                                               class="oe_inline"/>
                                    </div>
                                    <span class="col-lg-9 offset-lg-3 text-muted">
                                        Folder where processed files will be moved
                                    </span>
                                </div>
                            </setting>

                            <!-- STEP 3: File Size Limit -->
                            <setting id="max_file_size_setting"
                                     string="Step 3: File Size Limit"
                                     help="Maximum PDF file size to process automatically">
                                <div class="row">
                                    <label class="col-lg-3 o_light_label" for="google_drive_max_file_size_mb"/>
                                    <div class="col-lg-9">
                                        <field name="google_drive_max_file_size_mb" class="oe_inline"/>
                                        <span class="ms-2">MB</span>
                                    </div>
                                    <span class="col-lg-9 offset-lg-3 text-muted">
                                        Files larger than this will be automatically skipped and moved to "TooLarge" subfolder
                                    </span>
                                </div>
                            </setting>

                            <!-- STEP 4: Cron Job Control -->
                            <setting id="google_drive_cron_setting"
                                     string="Step 4: Auto-Extraction Cron"
                                     help="Enable or disable automatic scanning every 50 minutes">
                                <div class="row">
                                    <label class="col-lg-3 o_light_label" string="Cron Status"/>
                                    <div class="col-lg-9">
                                        <!-- Status Badge + Toggle -->
                                        <div class="d-flex align-items-center gap-3 mb-3">
                                            <span t-if="google_drive_cron_active" class="badge bg-success px-3 py-2">
                                                <i class="fa fa-check-circle"/> Active - Scanning every 50 minutes
                                            </span>
                                            <span t-else="" class="badge bg-secondary px-3 py-2">
                                                <i class="fa fa-times-circle"/> Inactive - Auto-extraction disabled
                                            </span>
                                        </div>

                                        <!-- Checkbox toggle -->
                                        <div class="form-check">
                                            <field name="google_drive_cron_active" widget="boolean_toggle"/>
                                            <label class="form-check-label ms-2">
                                                Enable automatic extraction cron job
                                            </label>
                                        </div>
                                    </div>
                                    <span class="col-lg-9 offset-lg-3 text-muted mt-2">
                                        When enabled, the system will automatically scan configured folders every 50 minutes and extract new PDFs
                                    </span>
                                </div>
                            </setting>

                            <!-- Action Buttons -->
                            <setting id="google_drive_actions_setting"
                                     string="Actions"
                                     help="Test connection or clear all configuration">
                                <div class="d-flex gap-2">
                                    <button string="Test Connection"
                                            name="action_test_google_drive_connection"
                                            type="object"
                                            class="btn btn-success"
                                            icon="fa-plug"
                                            invisible="not google_drive_configured"/>
                                    <button string="Clear All Configuration"
                                            name="action_clear_google_drive_config"
                                            type="object"
                                            class="btn btn-danger"
                                            icon="fa-trash"
                                            confirm="Are you sure you want to clear all Google Drive configuration? This action cannot be undone."
                                            invisible="not google_drive_configured"/>
                                </div>
                            </setting>

                            <!-- Instructions Collapsible -->
                            <div class="alert alert-info mt-3">
                                <details>
                                    <summary class="fw-bold" style="cursor: pointer;">
                                        <i class="fa fa-info-circle"/> How to configure Google Drive Integration (Click to expand)
                                    </summary>
                                    <div class="mt-3">
                                        <h5>Setup Instructions:</h5>
                                        <ol>
                                            <li><strong>Create Service Account:</strong>
                                                <ul>
                                                    <li>Go to <a href="https://console.cloud.google.com/iam-admin/serviceaccounts" target="_blank">Google Cloud Console → Service Accounts</a></li>
                                                    <li>Create new service account or select existing one</li>
                                                </ul>
                                            </li>
                                            <li><strong>Enable Drive API:</strong>
                                                <ul>
                                                    <li>Go to <a href="https://console.cloud.google.com/apis/library/drive.googleapis.com" target="_blank">APIs Library</a></li>
                                                    <li>Search "Google Drive API" and enable it</li>
                                                </ul>
                                            </li>
                                            <li><strong>Download JSON Key:</strong>
                                                <ul>
                                                    <li>In Service Accounts, click <strong>Keys → Add Key → Create New Key → JSON</strong></li>
                                                    <li>Download the JSON file (e.g., <code>project-123.json</code>)</li>
                                                </ul>
                                            </li>
                                            <li><strong>Create Drive Folders:</strong>
                                                <ul>
                                                    <li>Create 3 folders in your Google Drive: <strong>Form01</strong>, <strong>Form02</strong>, <strong>Processed</strong></li>
                                                    <li>Copy service account email (e.g., <code>my-service@project.iam.gserviceaccount.com</code>)</li>
                                                    <li>Share all 3 folders with this email (give <strong>Editor</strong> permission)</li>
                                                </ul>
                                            </li>
                                            <li><strong>Get Folder IDs:</strong>
                                                <ul>
                                                    <li>Open each folder in browser</li>
                                                    <li>Copy ID from URL: <code>https://drive.google.com/drive/folders/<strong>FOLDER_ID_HERE</strong></code></li>
                                                </ul>
                                            </li>
                                            <li><strong>Configure in Odoo:</strong>
                                                <ul>
                                                    <li>Upload the JSON file in Step 1</li>
                                                    <li>Enter the 3 folder IDs in Step 2</li>
                                                    <li>Set file size limit in Step 3</li>
                                                    <li>Enable cron in Step 4</li>
                                                    <li>Click "Test Connection" to verify</li>
                                                </ul>
                                            </li>
                                        </ol>
                                    </div>
                                </details>
                            </div>
                        </div>
                    </block>
                </div>
            </form>
        </field>
    </record>
</odoo>

<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <record id="view_document_extractor_config_form_standalone" model="ir.ui.view">
        <field name="name">document.extractor.config.form.standalone</field>
        <field name="model">res.config.settings</field>
        <field name="priority">1000</field>
        <field name="arch" type="xml">
            <form string="Document Extractor Settings" class="oe_form_configuration" js_class="base_settings">
                <div class="app_settings_block">
                    <block title="AI Configuration">
                        <!-- Core API Keys -->
                        <setting id="gemini_api_key_setting"
                                 help="Configure your Google Gemini API key for AI-powered document extraction">
                            <field name="gemini_api_key" password="True" placeholder="AIza..." class="oe_inline"/>
                            <div class="content-group mt8">
                                <div class="text-muted">
                                    Get your API key from <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a>
                                </div>
                            </div>
                        </setting>

                        <setting id="llama_cloud_api_key_setting"
                                 string="LlamaCloud API Key"
                                 help="Configure your LlamaCloud API key for OCR extraction with bounding boxes">
                            <field name="llama_cloud_api_key" password="True" placeholder="llx-..." class="oe_inline"/>
                            <div class="content-group mt8">
                                <div class="text-muted">
                                    Get your API key from <a href="https://cloud.llamaindex.ai/" target="_blank">LlamaCloud Console</a>
                                </div>
                            </div>
                        </setting>

                        <!-- Extraction Strategy -->
                        <setting id="extraction_strategy_setting"
                                 string="Extraction Strategy"
                                 help="Choose how PDF documents are processed for extraction"
                                 invisible="1">
                            <field name="extraction_strategy" widget="radio" class="o_light_label"/>
                            <div class="content-group mt8">
                                <div class="text-muted">
                                    <strong>100% AI (Recommended):</strong> Gemini processes PDF directly, understanding layout and structure.<br/>
                                    <strong>Text Extract + AI:</strong> Extract text first with PyMuPDF, then structure with AI. May be faster for very large PDFs.<br/>
                                    <strong>Batch Extraction:</strong> Convert PDF to images, process in batches with adaptive sizing. Best for very large documents (20+ pages).
                                </div>
                            </div>
                        </setting>

                        <!-- Gemini Core Configuration -->
                        <setting id="gemini_model_setting"
                                 string="Gemini Model"
                                 help="Select the Gemini model to use for extraction. Different models have different capabilities and costs."
                                >
                            <field name="gemini_model" class="oe_inline" placeholder="gemini-2.5-pro"/>
                            <div class="content-group mt8">
                                <div class="text-muted">
                                    Available models: gemini-3-pro-preview, gemini-2.5-pro
                                    <br/>
                                    See <a href="https://ai.google.dev/gemini-api/docs/models/gemini" target="_blank">Gemini Models documentation</a> for details.
                                </div>
                            </div>
                        </setting>

                        <setting id="gemini_max_output_tokens_setting"
                                 string="Max Output Tokens"
                                 help="Maximum number of tokens for Gemini API response. Increase if extraction fails for very long documents."
                                 invisible="1">
                            <field name="gemini_max_output_tokens" class="oe_inline"/>
                            <div class="content-group mt8">
                                <div class="text-muted">
                                    Recommended: 65536 (maximum for Gemini 2.0 Flash). Reduce if you want to limit API costs.
                                </div>
                            </div>
                        </setting>

                        <setting id="gemini_max_retries_setting"
                                 string="Max Retries"
                                 help="Maximum retry attempts when Gemini API extraction fails. Retries are executed immediately without delay."
                                 invisible="1">
                            <field name="gemini_max_retries" class="oe_inline"/>
                            <div class="content-group mt8">
                                <div class="text-muted">
                                    Default: 3 retries executed immediately. Increase for unreliable API responses.
                                </div>
                            </div>
                        </setting>

                        <!-- Gemini Advanced Parameters -->
                        <setting id="gemini_temperature_setting"
                                 string="Temperature"
                                 help="Controls randomness in Gemini output. 0.0 = fully deterministic (recommended for accuracy)."
                                 >
                            <field name="gemini_temperature"/>
                            <div class="content-group mt8">
                                <div class="text-muted">
                                    <strong>0.0:</strong> Fully deterministic (recommended for data extraction)<br/>
                                    <strong>0.1-0.3:</strong> Low randomness, consistent results<br/>
                                    <strong>0.5-1.0:</strong> Higher creativity (NOT recommended)
                                </div>
                            </div>
                        </setting>

                        <setting id="gemini_top_p_setting"
                                 string="Top P (Nucleus Sampling)"
                                 help="Controls diversity by limiting token selection. 0.95 = consider top 95% probability mass (recommended)."
                                 >
                            <field name="gemini_top_p"/>
                            <div class="content-group mt8">
                                <div class="text-muted">
                                    <strong>0.95:</strong> Recommended - considers top 95% probability tokens<br/>
                                    <strong>1.0:</strong> Maximum flexibility - considers all tokens<br/>
                                    <strong>&lt;0.8:</strong> May miss rare but accurate tokens
                                </div>
                            </div>
                        </setting>

                        <setting id="gemini_top_k_setting"
                                 string="Top K"
                                 help="Limits vocabulary to top K tokens. 0 = no limit (recommended for precision)."
                                 >
                            <field name="gemini_top_k"/>
                            <div class="content-group mt8">
                                <div class="text-muted">
                                    <strong>0:</strong> No limit (recommended for maximum accuracy with specialized terms)<br/>
                                    <strong>40:</strong> Only consider 40 most likely tokens<br/>
                                    Set to 0 for precision with rare/specialized terms
                                </div>
                            </div>
                        </setting>
                    </block>

                    <!-- Batch Extraction Configuration -->
                    <block title="Batch Extraction Configuration" invisible="1">
                        <setting id="batch_size_min_setting"
                                 string="Minimum Batch Size"
                                 help="Minimum pages per API call for complex documents with many table rows">
                            <field name="batch_size_min" class="oe_inline"/>
                            <div class="content-group mt8">
                                <div class="text-muted">
                                    For documents with many tables (complex): process fewer pages per API call for better accuracy.
                                    Recommended: 3 pages.
                                </div>
                            </div>
                        </setting>
                        <setting id="batch_size_max_setting"
                                 string="Maximum Batch Size"
                                 help="Maximum pages per API call for simple documents with few table rows">
                            <field name="batch_size_max" class="oe_inline"/>
                            <div class="content-group mt8">
                                <div class="text-muted">
                                    For simple documents: process more pages per API call for efficiency.
                                    Recommended: 7 pages.
                                </div>
                            </div>
                        </setting>
                        <setting id="batch_image_dpi_setting"
                                 string="Image Resolution (DPI)"
                                 help="Resolution when converting PDF to images">
                            <field name="batch_image_dpi" class="oe_inline"/>
                            <div class="content-group mt8">
                                <div class="text-muted">
                                    Higher DPI = better image quality but larger file sizes and longer processing time.
                                    Recommended range: 150-300 DPI. Default: 200 DPI.
                                </div>
                            </div>
                        </setting>
                    </block>

                    <block title="AI Extraction Prompts Configuration" invisible="1">
                        <setting id="extraction_prompts_setting" string="Direct Extraction Prompts">
                            <div class="d-flex gap-2">
                                <button string="Get Register Prompt" name="action_get_prompt_form_01" type="object" class="btn btn-outline-primary"/>
                                <button string="Get Report Prompt" name="action_get_prompt_form_02" type="object" class="btn btn-outline-primary"/>
                            </div>
                            <div class="content-group mt8">
                                <div class="text-muted">
                                    Reset prompts for direct extraction strategies (100% AI and Text Extract + AI).
                                </div>
                            </div>
                        </setting>
                        <setting id="batch_extraction_prompts_setting"
                                 string="Batch Extraction Prompts"
                                 invisible="extraction_strategy != 'batch_extract'">
                            <div class="d-flex gap-2">
                                <button string="Get Batch Register Prompt" name="action_get_batch_prompt_form_01" type="object" class="btn btn-outline-primary"/>
                                <button string="Get Batch Report Prompt" name="action_get_batch_prompt_form_02" type="object" class="btn btn-outline-primary"/>
                            </div>
                            <div class="content-group mt8">
                                <div class="text-muted">
                                    Reset prompts for batch extraction strategy. These prompts are optimized for per-page extraction with context memory.
                                </div>
                            </div>
                        </setting>
                    </block>

                    <block title="Integrations">
                        <setting id="google_drive_integration_setting"
                                 string="Google Drive Integration"
                                 class="col w-100"
                                 help="Configure Google Drive integration to sync documents for extraction">
                            <div id="google_drive_enabled" class="col-12 col-lg-12 o_setting_box">
                                <div class="o_setting_left_pane">
                                    <field name="google_drive_enabled" readonly="False"/>
                                </div>
                                <div class="o_setting_right_pane">
                                    <label for="google_drive_enabled"/>
                                </div>
                            </div>
                            <div class="content-group" invisible="not google_drive_enabled">
                                <!-- Hidden field that triggers recompute when JSON changes -->
                                <field name="google_drive_service_account_json" invisible="1"/>

                                <div class="row mt16">
                                    <label class="col-lg-3 o_light_label" for="google_drive_max_file_size_mb"/>
                                    <div  class="col-lg-9">
                                        <field name="google_drive_max_file_size_mb" class="col-lg-9 oe_inline"/>
                                    </div>
                                    <span class="col-lg-9 offset-lg-3 text-muted">
                                        Files larger than this size will be automatically skipped during scanning
                                    </span>
                                </div>

                                <div class="row mt16">
                                    <label class="col-lg-3 o_light_label" for="google_drive_configured" string="Service Account"/>
                                    <div class="col-lg-9">
                                        <field name="google_drive_configured" invisible="1"/>
                                        <field name="google_drive_service_account_email" readonly="1" invisible="not google_drive_service_account_email" class="w-100"/>
                                        <div class="mt-2 d-flex gap-2">
                                            <button string="Configure Service Account"
                                                    name="action_open_google_drive_config_wizard"
                                                    type="object"
                                                    class="btn btn-primary"
                                                    icon="fa-upload"/>
                                            <button string="Test Connection"
                                                    name="action_test_google_drive_connection"
                                                    type="object"
                                                    class="btn btn-success ms-2"
                                                    icon="fa-plug"
                                                    invisible="not google_drive_configured"/>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mt16" invisible="not google_drive_configured">
                                    <div class="col-12">
                                        <div class="alert alert-success">
                                            <i class="fa fa-check-circle"/> Google Drive is configured and ready to use.
                                            Click "Configure Service Account" to update credentials or folder settings.
                                        </div>
                                    </div>
                                </div>
                                <div class="row mt16" invisible="google_drive_configured">
                                    <div class="col-12">
                                        <div class="alert alert-warning">
                                            <i class="fa fa-exclamation-triangle"/> Google Drive is not configured yet.
                                            Click "Configure Service Account" to upload your service account JSON file.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </setting>
                    </block>
                </div>
            </form>
        </field>
    </record>
</odoo>
